Option Explicit

Sub Entity_DBA_Trade_AKA_FKA_Name_Google_Edge_Screenshot()
    Dim ws As Worksheet, names As Collection
    Dim i As Long, nm As Variant
    Dim pdfDir As String, fileName As String
    Dim pid As Long

    ' === Read names from ACTIVE sheet, row 11, from column E ? until first blank ===
    Set ws = ActiveSheet
    Set names = New Collection
    For i = 5 To ws.Columns.Count
        Dim v As String
        v = Trim$(CStr(ws.Cells(11, i).value))
        If v = "" Then Exit For
        names.Add v
    Next i
    If names.Count = 0 Then
        MsgBox "No names found on " & ws.name & " in row 11 from column E.", vbExclamation
        Exit Sub
    End If

    ' === Output folder ===
    pdfDir = "C:\Users\Dinesh\Desktop\SearchPDFs\"
    If Dir(pdfDir, vbDirectory) = vbNullString Then MkDir pdfDir

    ' === Launch Microsoft Edge ===
    pid = LaunchEdge()
    If pid = 0 Then
        MsgBox "Microsoft Edge not found.", vbCritical
        Exit Sub
    End If

    ' Give Edge time to show (use the safe focuser that retries)
    FocusEdge pid
    Application.wait Now + TimeValue("0:00:02")

    ' Maximize Edge (Alt+Space, X) — screenshot timings
    sendKeys "% ", True
    Application.wait Now + TimeValue("0:00:02")
    sendKeys "x", True
    Application.wait Now + TimeValue("0:00:02")

    ' === Loop each name ? Google search ? Print to PDF (screenshot timings) ===
    Dim url As String
    For Each nm In names
        url = "https://www.google.com/search?q=" & URLEncode(CStr(nm))

        ' Focus address bar and navigate
        FocusEdge pid
        sendKeys "^{l}", True
        Application.wait Now + TimeValue("0:00:02")
        sendKeys url, True
        Application.wait Now + TimeValue("0:00:02")
        sendKeys "{ENTER}", True

        ' Wait for results to load (8s like your screenshot)
        Application.wait Now + TimeValue("0:00:08")

        ' Open print dialog and accept default printer (Microsoft Print to PDF)
        FocusEdge pid
        sendKeys "^{p}", True
        Application.wait Now + TimeValue("0:00:08")
        sendKeys "{ENTER}", True
        Application.wait Now + TimeValue("0:00:08")

        ' Type full path & save (4s type, 5s finalize — screenshot timings)
        fileName = pdfDir & "Entity_DBA_Trade_AKA_FKA_Name_" & CStr(nm) & ".pdf"
        sendKeys fileName, True
        Application.wait Now + TimeValue("0:00:04")
        sendKeys "{ENTER}", True
        Application.wait Now + TimeValue("0:00:05")
    Next nm

    MsgBox "Done. PDFs saved to: " & pdfDir, vbInformation
End Sub

' ---- Helpers ----

Private Function LaunchEdge() As Long
    Dim p1 As String, p2 As String
    p1 = "C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe"
    p2 = "C:\Program Files\Microsoft\Edge\Application\msedge.exe"
    If Dir(p1, vbNormal) <> "" Then
        LaunchEdge = Shell("""" & p1 & """", vbNormalFocus)
    ElseIf Dir(p2, vbNormal) <> "" Then
        LaunchEdge = Shell("""" & p2 & """", vbNormalFocus)
    Else
        LaunchEdge = 0
    End If
End Function

' Robust focus: try by PID, then by window title; retry briefly to avoid Run-time error 5
Private Sub FocusEdge(ByVal pid As Long)
    Dim ok As Boolean, tries As Long
    On Error Resume Next

    ' First try by PID a few times
    For tries = 1 To 20
        Err.Clear
        AppActivate pid
        If Err.Number = 0 Then
            ok = True
            Exit For
        End If
        DoEvents
        Application.wait Now + TimeValue("0:00:00") ' yield
    Next tries

    ' Fallback: try by title
    If Not ok Then
        For tries = 1 To 20
            Err.Clear
            AppActivate "Microsoft Edge"
            If Err.Number = 0 Then Exit For
            DoEvents
            Application.wait Now + TimeValue("0:00:00")
        Next tries
    End If
End Sub

Private Function URLEncode(ByVal s As String) As String
    Dim i As Long, ch As String, o As String
    For i = 1 To Len(s)
        ch = Mid$(s, i, 1)
        Select Case AscW(ch)
            Case 48 To 57, 65 To 90, 97 To 122, 45, 46, 95, 126
                o = o & ch
            Case Else
                o = o & "%" & Right$("0" & Hex(AscW(ch)), 2)
        End Select
    Next
    URLEncode = o
End Function

